#!/usr/bin/env bash
set -e

resolve_link() {
  $(type -p greadlink readlink | head -1) $1
}

abs_dirname() {
  local cwd="$(pwd)"
  local path="$1"

  while [ -n "$path" ]; do
    cd "${path%/*}"
    local name="${path##*/}"
    path="$(resolve_link "$name" || true)"
  done

  pwd
  cd "$cwd"
}

bin_root="$(abs_dirname "$0")"


definition="$1"
if [ -z "$definition" ]; then
  echo "usage: ruby-package DEFINITION"
fi

package="${definition##*/}"
prefix="/tmp/ruby-build/-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------/$package"


"${bin_root}/ruby-build" -v "$definition" "$prefix"
cwd="$(pwd)"
cd "${prefix}/.."

mkdir -p "${package}.rubypackage/bin"
cp "${bin_root}/../share/ruby-package/ruby-package-install" "${package}.rubypackage/bin"
cp "${bin_root}/../share/ruby-package/ruby-package-rewrite-text" "${package}.rubypackage/bin"
cc -Wall "${bin_root}/../share/ruby-package/ruby-package-rewrite-binary.c" -o "${package}.rubypackage/bin/ruby-package-rewrite-binary"

mkdir -p "${package}.rubypackage/metadata"
echo -n "$prefix" > "${package}.rubypackage/metadata/prefix"
echo -n "$package" > "${package}.rubypackage/metadata/package"

cd "$package"

while read line; do
  binary="${line#Binary file }"
  if [ "$line" = "$binary" ]; then
    # plain text match
    text="${line%%:*}"
    echo "$text" >> "../${package}.rubypackage/metadata/text-files"
  else
    # binary match
    binary="${binary% matches}"
    echo "$binary" >> "../${package}.rubypackage/metadata/binary-files"
  fi
done < <( grep -m 1 -R "$prefix" * )

tar cf "../${package}.rubypackage/package.tar" *

cd ..

tar czf "${cwd}/${package}.rubypackage.tar.gz" "${package}.rubypackage"
rm -fr "${package}.rubypackage"
